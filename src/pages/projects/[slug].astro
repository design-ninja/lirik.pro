---
import { type CollectionEntry, getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import ProjectPreview from '../../components/Portfolio/ProjectPreview.astro';
import { sortItemsByDateDesc } from '../../utils/data-utils';

export const prerender = true;

export async function getStaticPaths() {
  const projects = (await getCollection('projects')).sort(sortItemsByDateDesc);
  const projectCount = projects.length;
  return projects.map((project, index) => ({
    params: { slug: project.slug },
    props: {
      project,
      prevProject: index + 1 !== projectCount ? projects[index + 1] : null,
      nextProject: index !== 0 ? projects[index - 1] : null
    }
  }));
}

type Props = { project: CollectionEntry<'projects'>; prevProject: CollectionEntry<'projects'>; nextProject: CollectionEntry<'projects'> };

// Support both SSG (props from getStaticPaths) and SSR (lookup by slug)
const { project: propProject, prevProject: propPrev, nextProject: propNext } = Astro.props as Partial<Props>;

let project = propProject as CollectionEntry<'projects'> | undefined;
let prevProject = (propPrev as CollectionEntry<'projects'> | null | undefined) ?? null;
let nextProject = (propNext as CollectionEntry<'projects'> | null | undefined) ?? null;

if (!project) {
  const slug = Astro.params.slug as string | undefined;
  const projects = (await getCollection('projects')).sort(sortItemsByDateDesc);
  const index = slug ? projects.findIndex((p) => p.slug === slug) : -1;
  if (index === -1) {
    return new Response(null, { status: 404 });
  }
  project = projects[index];
  prevProject = index !== 0 ? projects[index - 1] : null;
  nextProject = index + 1 !== projects.length ? projects[index + 1] : null;
}

const { title, description, seo, tags, link } = project.data;
const { Content } = await project.render();
---

<BaseLayout title={seo?.title ?? title} description={seo?.description ?? description} image={seo?.image} pageType="article">
  <article class="article">
    <header>
      <h1>{title}</h1>
      <div class="article__meta">
        {tags && <span class="article__tags">{tags.join(', ').replace(/,(?!.*,)/gim, ' и')}</span>}
        {
          link && (
            <a href={link} target="_blank" rel="noopener noreferer" class="article__link" title={title}>
              {link}
            </a>
          )
        }
      </div>
    </header>
    <div>
      <Content />
    </div>
    {
      (prevProject || nextProject) && (
        <>
          <h2>Другие проекты</h2>
          <div class="article__nav">
            {nextProject && <ProjectPreview project={nextProject} headingLevel="h3" />}
            {prevProject && <ProjectPreview project={prevProject} headingLevel="h3" />}
          </div>
        </>
      )
    }
  </article>
</BaseLayout>

<style lang="scss">
  .article {
    display: grid;
    gap: var(--space-40);
    margin: 0 auto;
    max-width: 900px;

    &__top {
      display: grid;
      gap: var(--space-24);
    }

    &__meta {
      display: grid;
      gap: var(--space-8);
      justify-items: start;
    }

    &__tags {
      color: var(--color-text-secondary);
    }

    &__content {
      display: grid;
      gap: var(--space-40);

      &Main {
        display: grid;
      }
    }

    &__nav {
      display: grid;
      gap: var(--space-24);
      grid-template-columns: repeat(2, 1fr);

      @media (max-width: 900px) {
        grid-template-columns: 1fr;
      }
    }
  }
</style>
