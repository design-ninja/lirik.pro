---
import { getSiteLocaleConfig } from '../data/site-config';
import { getOgLocale, SUPPORTED_LOCALES, type Locale } from '../utils/i18n';
import { getAbsoluteLocaleUrl } from 'astro:i18n';
import '../styles/index.css';
import onestCyrillicUrl from '@fontsource-variable/onest/files/onest-cyrillic-wght-normal.woff2?url';
import onestLatinUrl from '@fontsource-variable/onest/files/onest-latin-wght-normal.woff2?url';

export type Props = {
  locale: Locale;
  title?: string;
  description?: string;
  image?: { src: string; alt?: string };
  canonicalHref?: string;
  pageType?: 'website' | 'article';
};

const { locale, title, description, image, canonicalHref, pageType = 'website' } = Astro.props as Props;
const site = getSiteLocaleConfig(locale);
const metaTitle = title ?? site.title;
const metaDescription = description ?? site.description;
const ogLocale = getOgLocale(locale);
const resolvedImage = image ?? site.image;
const absoluteImage = resolvedImage?.src ? new URL(resolvedImage.src, Astro.site ?? Astro.request.url).toString() : undefined;
const canonical = canonicalHref ?? new URL(Astro.request.url, Astro.site ?? Astro.request.url).toString();

// Generate alternate URLs for all locales
let currentPath = Astro.url.pathname.replace(/^\/en/, '') || '/';
// Remove trailing slash except for root path, then add it back for non-root paths
if (currentPath !== '/' && !currentPath.endsWith('/')) {
  currentPath = `${currentPath}/`;
}
const alternateUrls = SUPPORTED_LOCALES.map((loc) => ({
  locale: loc,
  url: getAbsoluteLocaleUrl(loc, currentPath)
}));
const criticalStyles = `
  :root { color-scheme: light dark; }
  body { margin: 0; font-family: 'Onest Variable', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--color-bg-base, oklch(0.975 0.0053 106.5)); color: var(--color-text-primary, oklch(0.2161 0.0061 56.04)); font-size: 16px; }
  main { display: grid; gap: 2.5rem; margin: auto; padding: 1rem; max-width: 1024px; }
  section { padding: 1.5rem 0; }
  .Intro__Header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
  .Intro__Content { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); align-items: center; gap: 2.5rem; }
  .Intro__Name { font-size: 1.25rem; font-weight: 500; }
  .Intro__AboutMain { font-size: 1.125rem; line-height: 1.4; }
  .InfoTable { display: flex; flex-direction: column; gap: 0.5rem; padding: 1.25rem; border-radius: var(--radius-m, 16px); border: 1px solid var(--color-border-primary, oklch(0.9232 0.0026 48.72));  }
  .InfoTable__Row { display: flex; flex-direction: column; gap: 0.125rem; font-family: monospace; font-size: 0.875rem; border-bottom: 1px solid var(--color-border-primary, oklch(0.9232 0.0026 48.72)); padding-bottom: 0.5rem; }
  .InfoTable__Row:last-child { border-bottom: none; padding-bottom: 0; }
  .InfoTable__RowLabel { color: var(--color-text-secondary, oklch(0.55 0.01 0)); }
  .InfoTable__RowValue { min-height: 1.5rem; display: inline-flex; align-items: center; }
`;
---

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preload" as="font" type="font/woff2" href={onestLatinUrl} crossorigin />
<link rel="preload" as="font" type="font/woff2" href={onestCyrillicUrl} crossorigin />
<link rel="dns-prefetch" href="https://gist.githubusercontent.com" />
<link rel="dns-prefetch" href="https://i.ytimg.com" />
<style is:inline set:html={criticalStyles}></style>
<title>{metaTitle}</title>
<meta name="description" content={metaDescription} />
<link rel="canonical" href={canonical} />
{alternateUrls.map(({ locale: loc, url }) => (
  <link rel="alternate" hreflang={loc} href={url} />
))}
<link rel="alternate" hreflang="x-default" href={getAbsoluteLocaleUrl('ru', currentPath)} />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
<link rel="shortcut icon" href="/favicon.ico" />
<link rel="sitemap" href="/sitemap-index.xml" />
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="RSS" />
<meta name="robots" content="max-image-preview:large" />
<meta property="og:type" content={pageType} />
<meta property="og:url" content={canonical} />
<meta property="og:title" content={metaTitle} />
<meta property="og:description" content={metaDescription} />
<meta property="og:locale" content={ogLocale} />
{absoluteImage && <meta property="og:image" content={absoluteImage} />}
{resolvedImage?.alt && <meta property="og:image:alt" content={resolvedImage.alt} />}
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={canonical} />
<meta property="twitter:title" content={metaTitle} />
<meta property="twitter:description" content={metaDescription} />
{absoluteImage && <meta property="twitter:image" content={absoluteImage} />}
{resolvedImage?.alt && <meta name="twitter:image:alt" content={resolvedImage.alt} />}
