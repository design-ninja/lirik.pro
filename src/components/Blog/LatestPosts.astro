---
import { getCollection } from 'astro:content';
import SectionTitle from '../SectionTitle.astro';
import FormattedDate from './FormattedDate.astro';
import { sortPostsByDateDesc } from '../../utils/data-utils';
import { slugify } from '../../utils/common-utils';
import { getSiteLocaleConfig } from '../../data/site-config';
import { formatUpdatedLabel, getLocalizedPath, type Locale } from '../../utils/i18n';

interface Props {
  limit?: number;
  locale: Locale;
}

const { limit = 3, locale } = Astro.props as Props;
const site = getSiteLocaleConfig(locale);
const posts = (await getCollection('blog', (entry) => entry.data.locale === locale)).sort(sortPostsByDateDesc);
const firstPosts = await Promise.all(
  posts.slice(0, limit).map(async (post) => ({ post, Content: (await post.render()).Content }))
);
const sectionLabel = site.blog.sectionAriaLabel;
const sectionTitle = site.blog.sectionTitle;
const moreLinkLabel = site.blog.moreLinkLabel;
const blogPath = getLocalizedPath('/blog', locale);
---

{posts?.length > 0 && (
  <section aria-label={sectionLabel} class="LatestPosts">
    <SectionTitle title={sectionTitle} />
    <div class="LatestPosts__List">
      {firstPosts.map(({ post, Content }) => {
        const postPath = getLocalizedPath(`/blog/${post.data.path}/`, locale);
        return (
          <article class="LatestPosts__Post">
            <h3 class="LatestPosts__Title">
              <a href={postPath}>{post.data.title}</a>
            </h3>
            <div class="LatestPosts__Body">
              <Content />
            </div>
            <div class="LatestPosts__Footer">
              <div class="LatestPosts__Date">
                <FormattedDate date={post.data.publishDate} locale={locale} />
                {post.data.updatedDate && (
                  <span class="LatestPosts__Updated">
                    {formatUpdatedLabel(locale)} <FormattedDate date={post.data.updatedDate} locale={locale} />
                  </span>
                )}
              </div>
              {(post.data.tags?.length ?? 0) > 0 && (
                <div class="LatestPosts__Tags">
                  {post.data.tags.map((tag) => (
                    <a href={getLocalizedPath(`/tags/${slugify(tag)}`, locale)}>
                      #{tag}
                    </a>
                  ))}
                </div>
              )}
            </div>
          </article>
        );
      })}
    </div>
    <div class="LatestPosts__More">
      <a href={blogPath}>{moreLinkLabel}</a>
    </div>
  </section>
)}

<style lang="scss">
  .LatestPosts {

    &__Post {
      max-width: 64ch;
    }

    &__List {
      display: flex;
      flex-direction: column;
      gap: var(--space-64);
    }

    &__Title {
        margin-top: 0;
      margin-bottom: var(--space-16);
    }

    &__Body {
      margin-top: var(--space-16);
    }

    &__Footer {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-8);
      margin-top: var(--space-24);
    }

    &__Date {
      font-size: var(--font-size-14);
      color: var(--color-text-secondary);
    }

    &__Updated {
      font-size: var(--font-size-14);
      color: var(--color-text-secondary);
    }

    &__Tags {
      font-size: var(--font-size-14);
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-8);
    }

    &__More {
      margin-top: var(--space-40);
    }
  }
</style>


